{"version":3,"file":"dropcursor.js","sources":["../src/dropcursor.js"],"sourcesContent":["import {Plugin} from \"prosemirror-state\"\nimport {Decoration, DecorationSet} from \"prosemirror-view\"\n\nconst gecko = typeof navigator != \"undefined\" && /gecko\\/\\d/i.test(navigator.userAgent)\nconst linux = typeof navigator != \"undefined\" && /linux/i.test(navigator.platform)\n\nexport function dropCursor(options) {\n  function dispatch(view, data) {\n    view.dispatch(view.state.tr.setMeta(plugin, data))\n  }\n\n  let timeout = null\n  function scheduleRemoval(view) {\n    clearTimeout(timeout)\n    timeout = setTimeout(() => {\n      if (plugin.getState(view.state)) dispatch(view, {type: \"remove\"})\n    }, 1000)\n  }\n\n  let plugin = new Plugin({\n    state: {\n      init() { return null },\n      apply(tr, prev, state) {\n        // Firefox on Linux gets really confused an breaks dragging when we\n        // mess with the nodes around the target node during a drag. So\n        // disable this plugin there. See https://bugzilla.mozilla.org/show_bug.cgi?id=1323170\n        if (gecko && linux) return null\n        let command = tr.getMeta(plugin)\n        if (!command) return prev\n        if (command.type == \"set\") return pluginStateFor(state, command.pos, options)\n        return null\n      }\n    },\n    props: {\n      handleDOMEvents: {\n        dragover(view, event) {\n          let active = plugin.getState(view.state)\n          let pos = view.posAtCoords({left: event.clientX, top: event.clientY})\n          if (pos) {\n            let target = pos.pos\n            if (view.dragging)\n              target = dropPos(view.dragging.slice, view.state.doc.resolve(target))\n            if (!active || active.pos != target)\n              dispatch(view, {type: \"set\", pos: target})\n          }\n          scheduleRemoval(view)\n          return false\n        },\n\n        dragend(view) {\n          if (plugin.getState(view.state)) dispatch(view, {type: \"remove\"})\n          return false\n        },\n\n        drop(view) {\n          if (plugin.getState(view.state)) dispatch(view, {type: \"remove\"})\n          return false\n        },\n\n        dragleave(view, event) {\n          if (event.target == view.dom) dispatch(view, {type: \"remove\"})\n          return false\n        }\n      },\n      decorations(state) {\n        let active = plugin.getState(state)\n        return active && active.deco\n      }\n    }\n  })\n  return plugin\n}\n\nfunction style(options, side) {\n  let width = (options && options.width) || 1\n  let color = (options && options.color) || \"black\"\n  return `border-${side}: ${width}px solid ${color}; margin-${side}: -${width}px`\n}\n\nfunction pluginStateFor(state, pos, options) {\n  let $pos = state.doc.resolve(pos), deco\n  if (!$pos.parent.inlineContent) {\n    let before, after\n    if (before = $pos.nodeBefore)\n      deco = Decoration.node(pos - before.nodeSize, pos, {nodeName: \"div\", style: style(options, \"right\")})\n    else if (after = $pos.nodeAfter)\n      deco = Decoration.node(pos, pos + after.nodeSize, {nodeName: \"div\", style: style(options, \"left\")})\n  }\n  if (!deco) {\n    let node = document.createElement(\"span\")\n    node.textContent = \"\\u200b\"\n    node.style.cssText = style(options, \"left\") + \"; display: inline-block; pointer-events: none\"\n    deco = Decoration.widget(pos, node)\n  }\n  return {pos, deco: DecorationSet.create(state.doc, [deco])}\n}\n\nfunction dropPos(slice, $pos) {\n  if (!slice || !slice.content.size) return $pos.pos\n  let content = slice.content\n  for (let i = 0; i < slice.openStart; i++) content = content.firstChild.content\n  for (let d = $pos.depth; d >= 0; d--) {\n    let bias = d == $pos.depth ? 0 : $pos.pos <= ($pos.start(d + 1) + $pos.end(d + 1)) / 2 ? -1 : 1\n    let insertPos = $pos.index(d) + (bias > 0 ? 1 : 0)\n    if ($pos.node(d).canReplace(insertPos, insertPos, content))\n      return bias == 0 ? $pos.pos : bias < 0 ? $pos.before(d + 1) : $pos.after(d + 1)\n  }\n  return $pos.pos\n}\n"],"names":["const","let","Plugin","Decoration","DecorationSet"],"mappings":"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"}